<!DOCTYPE html>
<html>
    <head>
        <title>MesengerService test page</title>
        </head>
    <body>
        <button onclick="addUser()">Add user</button>
        <button onclick="login()">Login</button>
        <button onclick="connect()">Connect</button>
        <pre id="output"></pre>
    </body>
    <script src="https://cdn.rawgit.com/CryptoStore/crypto-js/3.1.2/build/rollups/aes.js"></script>
    <script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
    
<script>
    const base64_iv  = 'fb4c5e213749eddadf1e22d723eaf207';
    let iv  = CryptoJS.enc.Hex.parse(base64_iv);
    var output = document.getElementById("output");
    var socket = io();
    var s2 = io("/");
    var token=""
    var generalKey = ""
    var WSKey = ""

    socket.on('connect', function(){ 
        output.innerHTML+=`Now Im Connected\n`
   });

   socket.on("Log In",function(user){
        output.innerHTML+= `I'm ${JSON.stringify(user)}\n`
   })

   socket.on("error",function(error){
        if('error' in error){
            output.innerHTML+= `I received a new server error: ${JSON.stringify(error.error)}\n`
        }else{
            output.innerHTML+= `I received a Connection error: ${JSON.stringify(error)}\n`
        }
       
   })


    window.onload = async function(){  
        let response = await fetch("http://localhost:8080/Key",{
            method: "Get",
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            }})
        let data = await response.json()
        output.innerHTML +="my Key for Normal request is" + data.initialValue+"\n"
        generalKey= CryptoJS.enc.Hex.parse(data.initialValue)
    }  


    async function addUser(){
        let response = await fetch("http://localhost:8080/User",{
            method: "post",
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            },

            //make sure to serialize your JSON body
            body: JSON.stringify({
            zone:"+506",
            number: "60032274",
            password:"Br4zz4",
            username:"Brazza"
            }) })
            let data = await response.json()
    }

    async function login(){

        var password = CryptoJS.AES.encrypt('Br4zz4',
                                            generalKey,
                                            { iv: iv,
                                              mode: CryptoJS.mode.CBC,
                                              padding: CryptoJS.pad.Pkcs7})

        temp_password= password.toString()
        //var plain = CryptoJS.AES.decrypt(passowrd.toString(),generalKey,
        //                                    { iv: iv,
        //                                      mode: CryptoJS.mode.CBC,
        //                                      padding: CryptoJS.pad.Pkcs7})


        let response = await fetch("http://localhost:8080/User/Login",{
            method: "post",
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            },
            //make sure to serialize your JSON body
            body: JSON.stringify({
            zone:"+506",
            number: "60032274",
            password: temp_password,
            username:"Brazza"
            }) })
        let data = await response.json()
        if(response.status==200){
            output.innerHTML+=`my new token is ${data.token}\n`
            token=data.token
        }else{
            output.innerHTML+=`Error: ${data.error}`
        }
    }

    function connect(){
        s2.emit("messenger",{info:token})
    }

</script>
</html>