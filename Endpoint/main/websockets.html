<!DOCTYPE html>
<html>
    <head>
        <title>MesengerService test page</title>
        </head>
    <body>
        <button onclick="addUser()">Add user</button>
        <button onclick="login()">Login</button>
        <button onclick="connect()">Connect</button>
        <button onclick="sendMessage()">Send Message</button>
        <pre id="output"></pre>
    </body>
    <script src="https://cdn.rawgit.com/CryptoStore/crypto-js/3.1.2/build/rollups/aes.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.5.0/socket.io.js"></script>
    
<script>
    const base64_iv  = 'fb4c5e213749eddadf1e22d723eaf207';
    let iv  = CryptoJS.enc.Hex.parse(base64_iv);
    var output = document.getElementById("output");
    var socket =  io();
    var localUser = null
    var token=""
    var generalKey = ""
    var WSKey = ""

    window.onload = async function(){  
        let response = await fetch("http://localhost:8080/Key",{
            method: "Get",
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            }})
        let data = await response.json()
        output.innerHTML +="my Key for Normal request is" + data.initialValue+"\n"
        generalKey= CryptoJS.enc.Hex.parse(data.initialValue)
    }  

    socket.on('connect', function(){ 
            output.innerHTML+=`Now Im Connected\n`
         });

    socket.on("Log In",function(encryptedUser){ 
            var plain = CryptoJS.AES.decrypt(encryptedUser,WSKey,
                                            { iv: iv,
                                                mode: CryptoJS.mode.CBC,
                                                padding: CryptoJS.pad.Pkcs7})
            user = JSON.parse(plain.toString(CryptoJS.enc.Utf8))
            localUser = user
            output.innerHTML+= `I'm ${JSON.stringify(localUser)}\n`
    })

    socket.on("WSKey",function(key){
            WSKey= CryptoJS.enc.Hex.parse(key)
            output.innerHTML+=`My key to Handle encrypted messages is ${key}\n`
    })

    socket.on("error",function(error){
            if('error' in error){
                output.innerHTML+= `I received a new server error: ${JSON.stringify(error.error)}\n`
            }else{
                output.innerHTML+= `I received a Connection error: ${JSON.stringify(error)}\n`
            }
        
    })

    async function addUser(){
        let user = JSON.stringify({
            zone:"+506",
            number: "62073447",
            password: "ponchoj113",
            username:"poncho"
            })
        let encryptedUser = CryptoJS.AES.encrypt(user,
                                            generalKey,
                                            { iv: iv,
                                              mode: CryptoJS.mode.CBC,
                                              padding: CryptoJS.pad.Pkcs7})

        temp_encryptedUser = encryptedUser.toString()


        let response = await fetch("http://localhost:8080/User",{
            method: "post",
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            },

            //make sure to serialize your JSON body
            body: JSON.stringify({
                user: temp_encryptedUser
            }) })
            
        if(response.status==200){
            output.innerHTML +=`User added`
        }else{
            output.innerHTML +=response.statusText
        }
    }

    async function login(){
        let user = JSON.stringify({
            zone:"+506",
            number: "60032274",
            password: "Br4zz4",
            username:"Brazza"
            })
        let encryptedUser = CryptoJS.AES.encrypt(user,
                                            generalKey,
                                            { iv: iv,
                                              mode: CryptoJS.mode.CBC,
                                              padding: CryptoJS.pad.Pkcs7})

        temp_encryptedUser = encryptedUser.toString()

        let response = await fetch("http://localhost:8080/User/Login",{
            method: "post",
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            },
            //make sure to serialize your JSON body
            body: JSON.stringify({user:temp_encryptedUser})})

        let data = await response.json()
        if(response.status==200){
            output.innerHTML+=`my new token is ${data.token}\n`
            token=data.token
        }else{
            output.innerHTML+=`Error: ${data.error}`
        }
    }

    function connect(){
        socket.emit("messenger",{info:token})
    }

    function sendMessage(){
        let message = CryptoJS.AES.encrypt("Hola! perro pelon :D",
                                            generalKey,
                                            { iv: iv,
                                              mode: CryptoJS.mode.CBC,
                                              padding: CryptoJS.pad.Pkcs7})

        temp_message= message.toString()
        socket.emit("sendMessage",{content:temp_message,from:localUser,numbers:[{zone:"+506",number:"62073447"}]})
    }

</script>
</html>