<!DOCTYPE html>
<html>
    <head>
        <title>MesengerService test page</title>
        </head>
    <body>
        <button onclick="addUser()">Add user</button>
        <button onclick="login()">Login</button>
        <button onclick="connect()">Connect</button>
        <pre id="output"></pre>
    </body>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.2/rollups/aes.js"></script>
    <script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
    
<script>
    var output = document.getElementById("output");
    var socket = io();
    var s2 = io("/");
    var token=""
    var generalKey = ""
    var WSKey = ""

    socket.on('connect', function(){ 
        output.innerHTML+=`Now Im Connected\n`
   });

   socket.on("Log In",function(user){
        output.innerHTML+= `I'm ${JSON.stringify(user)}\n`
   })

    window.onload = async function(){  
        let response = await fetch("http://localhost:8080/Key",{
            method: "Get",
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            }})
        let data = await response.json()
        output.innerHTML +="my Key for Normal request is" + data.initialValue+"\n"
        generalKey=data.initialValue
    }  


    async function addUser(){
        let response = await fetch("http://localhost:8080/User",{
            method: "post",
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            },

            //make sure to serialize your JSON body
            body: JSON.stringify({
            zone:"+506",
            number: "60032274",
            password:"Br4zz4",
            username:"Brazza"
            }) })
            let data = await response.json()
    }

    async function login(){
        let response = await fetch("http://localhost:8080/User/Login",{
            method: "post",
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            },

            //make sure to serialize your JSON body
            body: JSON.stringify({
            zone:"+506",
            number: "60032274",
            password:"Br4zz4",
            username:"Brazza"
            }) })
        let data = await response.json()
        if(response.status==200){
            output.innerHTML+=`my new token is ${data.token}\n`
            token=data.token
        }else{
            output.innerHTML+=`Error: ${data.error}`
        }
    }

    function connect(){
        s2.emit("messenger",{info:token})
    }

    function encryptMessage(messageToencrypt = '', secretkey = '')
    {         
        var encryptedMessage = CryptoJS.AES.encrypt(messageToencrypt, secretkey);
        return encryptedMessage.toString();       
    }

    function decryptMessage(encryptedMessage = '', secretkey = ''){
        var decryptedBytes = CryptoJS.AES.decrypt(encryptedMessage, secretkey);         
        var decryptedMessage = decryptedBytes.toString(CryptoJS.enc.Utf8);          
        return decryptedMessage;       
    } 

</script>
</html>